# üîí –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ì–û–¢–û–í–û!

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. CSRF-–∑–∞—â–∏—Ç–∞ –¥–ª—è inline-–∫–Ω–æ–ø–æ–∫

#### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- **`app/utils/csrf.py`** - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ nonce-—Ç–æ–∫–µ–Ω–æ–≤
- **`app/middlewares/csrf.py`** - Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ CSRF-—Ç–æ–∫–µ–Ω–æ–≤
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã** - –í—Å–µ callback_data —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—é—Ç nonce

#### üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
1. –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π nonce-—Ç–æ–∫–µ–Ω
2. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis-Storage
3. –í—Å–µ callback_data –≤–∫–ª—é—á–∞—é—Ç nonce –≤ —Ñ–æ—Ä–º–∞—Ç–µ `"{nonce}:{real_data}"`
4. Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π callback

#### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF-–∞—Ç–∞–∫
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ "—Å—ã—Ä—ã—Ö" callback-—Å—Ç—Ä–æ–∫
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö: "‚õîÔ∏è –ò—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è" / "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω"

### 2. BCrypt-—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

#### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- **`app/utils/hash.py`** - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª–µ–π
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `app/roles.py`** - –í—Å–µ –¥–µ–º–æ-–ø–∞—Ä–æ–ª–∏ —Ç–µ–ø–µ—Ä—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `app/bot.py`** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —Ö–µ—à–µ–π

#### üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
```python
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–µ—à–∞
password_hash = hash_pwd("teacher")  # bcrypt.gensalt()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
is_valid = check_pwd("teacher", password_hash)  # True
```

#### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (–¥–∞–∂–µ –≤ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö)
- –ó–∞—â–∏—Ç–∞ –æ—Ç rainbow table –∞—Ç–∞–∫
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### 3. Rate Limiting —Å Retry-After

#### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `app/middlewares/rate_limit.py`** - –î–æ–±–∞–≤–ª–µ–Ω—ã HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏
- **–¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è

#### üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ webhook-—Ä–µ–∂–∏–º—É

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:

#### 1. **`tests/test_add_note.py`** - FSM —Ç–µ—Å—Ç
- –≠–º—É–ª–∏—Ä—É–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É"
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ FSM –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞

#### 2. **`tests/test_tour.py`** - Integration —Ç–µ—Å—Ç
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É `/tour`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞

### üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install bcrypt pytest-aiogram

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest -q

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ ‚úÖ
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î
–ü–æ—Å–∫–æ–ª—å–∫—É –ø–∞—Ä–æ–ª–∏ —Ç–µ–ø–µ—Ä—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ volumes
docker-compose down -v

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ —Ö–µ—à–∞–º–∏
docker-compose up postgres redis -d
python -m app.bot  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ —Ö–µ—à–∏
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### ‚úÖ CSRF-–∑–∞—â–∏—Ç–∞:
- –í—Å–µ inline-–∫–Ω–æ–ø–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã nonce-—Ç–æ–∫–µ–Ω–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö callback
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π:
- –í—Å–µ –¥–µ–º–æ-–ø–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã bcrypt
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

### ‚úÖ Rate Limiting:
- –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ webhook-—Ä–µ–∂–∏–º—É

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

### ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
- ‚úÖ CSRF-nonce –¥–ª—è inline-–∫–Ω–æ–ø–æ–∫
- ‚úÖ BCrypt-—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ Rate-limit —Å Retry-After
- ‚úÖ Pytest-aiogram —Ç–µ—Å—Ç—ã
- ‚úÖ Happy-path FSM —Ç–µ—Å—Ç—ã
- ‚úÖ Integration —Ç–µ—Å—Ç—ã

### üõ°Ô∏è –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç** –¥–ª—è –¥–µ–º–æ-—Å–∏—Å—Ç–µ–º—ã
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**
- **–ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è! üéØ 