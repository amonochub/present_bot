# –û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ present_bot

## –û–±–∑–æ—Ä
–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Telegram-–±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∫–æ–ª–æ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram 3.x, SQLAlchemy 2.x, PostgreSQL –∏ Redis. –ê–Ω–∞–ª–∏–∑ –≤—ã—è–≤–∏–ª –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–¥–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º

### 1. –ü—Ä–æ–±–ª–µ–º—ã —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ (mypy - 206 –æ—à–∏–±–æ–∫)

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã**: 120+ —Ñ—É–Ω–∫—Ü–∏–π —Å –Ω–µ—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã**: `Base` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∫–∞–∫ —Ç–∏–ø
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤**: –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- **Deprecated –∏–º–ø–æ—Ä—Ç—ã**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ç–∏–ø–æ–≤ –∏–∑ `typing`

#### –ü—Ä–∏–º–µ—Ä—ã:
```python
# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
class User(Base):  # Base –Ω–µ –≤–∞–ª–∏–¥–Ω—ã–π —Ç–∏–ø

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ  
class User(DeclarativeBase):
```

### 2. –ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∏–ª—è –∫–æ–¥–∞ (ruff - 80+ –Ω–∞—Ä—É—à–µ–Ω–∏–π)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è:
- **–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∏–º–ø–æ—Ä—Ç—ã**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `typing.List`, `typing.Dict` –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
- **–ù–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã**: –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
- **–î–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –≤ 100 —Å–∏–º–≤–æ–ª–æ–≤
- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**
- **Imports –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ñ–∞–π–ª–∞**: –ú–æ–¥—É–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

#### –ü—Ä–∏–º–µ—Ä—ã:
```python
# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
from typing import List, Dict

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
from collections.abc import Sequence
```

### 3. –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (bandit - 5 –Ω–∞—Ä—É—à–µ–Ω–∏–π)

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:
1. **SQL Injection (4 —Å–ª—É—á–∞—è)** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ f-—Å—Ç—Ä–æ–∫ –¥–ª—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º** - –ë–∏–Ω–¥–∏–Ω–≥ –Ω–∞ `0.0.0.0`

#### –ü—Ä–∏–º–µ—Ä—ã SQL Injection:
```python
# ‚ùå –û–ü–ê–°–ù–û - SQL Injection
f"SELECT * FROM users WHERE tg_id = {tg_id}"

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û
select(User).where(User.tg_id == tg_id)
```

### 4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### –ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤:
- **–°–º–µ—à–∞–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ handlers
- **–ü—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã**: –û–±—Ö–æ–¥ ORM –¥–ª—è "–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
```python
# ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä—è–º–æ–π SQL –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
search_query = f"SELECT * FROM users WHERE username ILIKE '%{query}%'"

# ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ORM
stmt = select(User).where(User.username.ilike(f"%{query}%"))
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL Injection**
   ```python
   # –í app/repositories/optimized_user_repo.py
   # –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ f-—Å—Ç—Ä–æ–∫–∏ SQL –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   ```

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º**
   ```python
   # –í app/bot.py:421
   site = web.TCPSite(runner, "127.0.0.1", 8080)  # –í–º–µ—Å—Ç–æ 0.0.0.0
   ```

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π**
   ```python
   # –í app/db/base.py
   from sqlalchemy.orm import DeclarativeBase
   
   class Base(DeclarativeBase):
       pass
   ```

### üü° –í–∞–∂–Ω—ã–µ (–≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è)

4. **–û–±–Ω–æ–≤–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∏–º–ø–æ—Ä—Ç—ã**
   ```python
   # –ó–∞–º–µ–Ω–∏—Ç—å –≤–µ–∑–¥–µ
   from typing import List, Dict ‚Üí list, dict
   from typing import AsyncGenerator ‚Üí from collections.abc import AsyncGenerator
   ```

5. **–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤**
   ```python
   from typing import TypeVar, ParamSpec
   
   P = ParamSpec('P')
   T = TypeVar('T')
   ```

6. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∏–º–ø–æ—Ä—Ç—ã**

### üü¢ –£–ª—É—á—à–µ–Ω–∏—è (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)

7. **–†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ isort**
8. **–†–∞–∑–±–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏**
9. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
10. **–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫ —Ñ—É–Ω–∫—Ü–∏—è–º**

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º

### Pre-commit hooks
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.12.0
    hooks:
      - id: black
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.8
    hooks:
      - id: ruff
        args: [--fix]
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
```

### CI/CD –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```yaml
# .github/workflows/quality.yml
name: Code Quality
on: [push, pull_request]
jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run ruff
        run: ruff check .
      - name: Run mypy
        run: mypy app/
      - name: Run bandit
        run: bandit -r app/
```

## –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- **Ruff –æ—à–∏–±–æ–∫**: 80+
- **MyPy –æ—à–∏–±–æ–∫**: 206
- **Bandit –æ—à–∏–±–æ–∫**: 5 (–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö)
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**: ~80%
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞**: –í—ã—Å–æ–∫–∞—è

### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
- **Ruff –æ—à–∏–±–æ–∫**: 0
- **MyPy –æ—à–∏–±–æ–∫**: 0
- **Bandit –æ—à–∏–±–æ–∫**: 0
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**: 90%+
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞**: –°—Ä–µ–¥–Ω—è—è

## –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**: 2-3 –¥–Ω—è
- **–í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**: 1-2 –Ω–µ–¥–µ–ª–∏  
- **–£–ª—É—á—à–µ–Ω–∏—è**: 3-4 –Ω–µ–¥–µ–ª–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ —É–ª—É—á—à–µ–Ω–∏—é —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –∏ —Å—Ç–∏–ª—è –∫–æ–¥–∞.
