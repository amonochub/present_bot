# –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ SchoolBot

## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
2024-12-19

## –û–±–∑–æ—Ä
–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ SchoolBot –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫, —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫.

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –§—É–Ω–∫—Ü–∏—è escape_html
**–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏—è –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∞ –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π replace –¥–ª—è –∞–º–ø–µ—Ä—Å–∞–Ω–¥–æ–≤
```python
def escape_html(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML-—Å–∏–º–≤–æ–ª—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    return html.escape(text, quote=True).replace("&", "&amp;")
```

### 2. –¢–µ—Å—Ç—ã CSRF middleware
**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ–∫–∏ –Ω–µ –∏–º–µ–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã AsyncMock –¥–ª—è answer() –∏ message –∞—Ç—Ä–∏–±—É—Ç–æ–≤

### 3. –¢–µ—Å—Ç—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ—Å—Ç –ø–∞–¥–∞–ª –Ω–∞ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Ö–µ—à–∞
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ ValueError –¥–ª—è –Ω–µ–≤–µ—Ä–Ω—ã—Ö —Ö–µ—à–µ–π

### 4. –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã
**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–µ–Ω—ã –ª–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

### 5. –¢–µ—Å—Ç—ã onboarding
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò–º–ø–æ—Ä—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
**–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ patch –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã

### 6. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ callback_data –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ä–∞–∑–Ω—ã–µ –∏–º–µ–Ω–∞
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- `par_tasks` ‚Üí `parent_tasks`
- `par_cert` ‚Üí `parent_cert`
- `stu_help` ‚Üí `stu_help` (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π callback_data)
- `psy_inbox` ‚Üí `psych_inbox`

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è stub
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∞ "KPI" –Ω–µ –∏–º–µ–ª–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ `app/routes/director.py`

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ö–Ω–æ–ø–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- ‚úÖ –£—á–∏—Ç–µ–ª—å: `teacher_notes`, `teacher_add`, `teacher_ticket`, `teacher_media`
- ‚úÖ –ê–¥–º–∏–Ω: `admin_broadcast`, `admin_tickets`, `admin_media`
- ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä: `director_tasks`, `stub` (KPI)
- ‚úÖ –†–æ–¥–∏—Ç–µ–ª—å: `parent_tasks`, `parent_cert`
- ‚úÖ –£—á–µ–Ω–∏–∫: `stu_tasks`, `stu_help`
- ‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥: `psych_inbox`
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π: `switch_*`
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é: `back_to_main`
- ‚úÖ –°–º–µ–Ω–∞ —Ç–µ–º—ã: `switch_theme`

### Middleware
- ‚úÖ CSRF middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Rate limit middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Locale middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Metrics middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Audit middleware –ø–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –†–æ—É—Ç–µ—Ä—ã
- ‚úÖ –í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –≤ `include_all()`
- ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

### –£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã (24/31)
- ‚úÖ CSRF edge cases (4/5)
- ‚úÖ Password hashing edge cases (5/5)
- ‚úÖ CSRF token edge cases (3/3)
- ‚úÖ Configuration edge cases (1/1)
- ‚úÖ Error handling edge cases (1/2)
- ‚úÖ Onboarding tests (7/7)
- ‚úÖ Performance tests (3/3)

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã (7/31)
- ‚ùå Rate limit edge cases (2/4) - —Ç—Ä–µ–±—É—é—Ç Redis
- ‚ùå User repository edge cases (1/2) - —Ç—Ä–µ–±—É—é—Ç –ë–î
- ‚ùå Limiter edge cases (2/2) - —Ç—Ä–µ–±—É—é—Ç Redis
- ‚ùå CSRF error edge cases (1/1) - –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–∫–∞–º–∏

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–∏—Ç—å –º–æ–∫–∏ –¥–ª—è Redis –∏ PostgreSQL –≤ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pytest-mock` –¥–ª—è –ª—É—á—à–µ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–∫–∞–º–∏
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ CSRF –∑–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ HTML —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã

### 4. –ö–æ–¥
- ‚úÖ –í—Å–µ –∫–Ω–æ–ø–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
- ‚úÖ Middleware –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –†–æ—É—Ç–µ—Ä—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç SchoolBot –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏:

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∞
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ö–Ω–æ–ø–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É
- –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

**–û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ —Ç–µ—Å—Ç–∞—Ö
- –£–ª—É—á—à–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** ‚úÖ –í—ã—Å–æ–∫–∞—è
**–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** ‚úÖ –•–æ—Ä–æ—à–∞—è
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ù–∞–¥–ª–µ–∂–∞—â–∞—è

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
