# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–Ω–æ–ø–∫–æ–π "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é"

## üêõ –ü—Ä–æ–±–ª–µ–º–∞
–ö–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ - –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–∏—á–∏–Ω–∞:
**–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ nonce –≤ callback –¥–∞–Ω–Ω—ã—Ö**

1. **CSRF Middleware**: –¢—Ä–µ–±—É–µ—Ç nonce –≤ —Ñ–æ—Ä–º–∞—Ç–µ `nonce:data` –¥–ª—è –≤—Å–µ—Ö callback –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ demo_switch()**: –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–æ–ª–µ–π –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è –Ω–æ–≤—ã–π nonce
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: CSRF middleware –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª callback –∑–∞–ø—Ä–æ—Å—ã

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:
```python
# –ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∞ 355):
reply_markup=menu(role_target, lang, user.theme),  # –Ω–µ—Ç nonce!

# –°—Ç–∞–ª–æ:
nonce = await issue_nonce(dp.storage, call.message.chat.id, call.from_user.id)
reply_markup=menu(role_target, lang, user.theme, nonce),  # —Å nonce!
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/bot.py`:

#### **–î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è nonce –≤ —Ñ—É–Ω–∫—Ü–∏–∏ demo_switch():**
```python
if call.message is not None and hasattr(call.message, "edit_text"):
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π nonce –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–µ–Ω—é
    nonce = await issue_nonce(dp.storage, call.message.chat.id, call.from_user.id)
    await call.message.edit_text(
        f"üöÄ –í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –≤ —Ä–µ–∂–∏–º ¬´{ROLES[role_target]}¬ª",
        reply_markup=menu(role_target, lang, user.theme, nonce),
    )
    await call.answer()
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π nonce
2. **CSRF middleware** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç nonce –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
3. **Callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è** —Ñ—É–Ω–∫—Ü–∏–µ–π demo_switch()
4. **–†–æ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
5. **–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** —Å –Ω–æ–≤—ã–º nonce

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### CSRF Middleware –ª–æ–≥–∏–∫–∞:
```python
# app/middlewares/csrf.py
try:
    nonce, real_data = event.data.split(":", 1)
except ValueError:  # –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
    await event.answer("‚õîÔ∏è –ò—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.", show_alert=True)
    return
```

### Callback Data —Ñ–æ—Ä–º–∞—Ç:
- **–ë—ã–ª–æ**: `switch_super` (–±–µ–∑ nonce)
- **–°—Ç–∞–ª–æ**: `abc123:switch_super` (—Å nonce)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ –ö–∞–∂–¥—ã–π callback –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π nonce
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –í–æ–π–¥–∏—Ç–µ –≤ –¥–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç: `demo01` / `demo`
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ –ª—é–±—É—é —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Å–∏—Ö–æ–ª–æ–≥–∞)
3. –ù–∞–∂–º–∏—Ç–µ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é"
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –≤—ã–±–æ—Ä—É —Ä–æ–ª–µ–π
5. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ –¥—Ä—É–≥—É—é —Ä–æ–ª—å
6. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–æ–ª—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "–ò—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è"
- ‚úÖ –ü–æ–ª–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

## üìù –°—Ç–∞—Ç—É—Å
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è nonce –≤ demo_switch()
- ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ**: –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
- ‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**: –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç
–¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ –≤—Å–µ—Ö —Ä–æ–ª—è—Ö. CSRF –∑–∞—â–∏—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!
