# KPI –ú–µ—Ç—Ä–∏–∫–∏ - –ü–æ—Ä—É—á–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è KPI –ø–æ—Ä—É—á–µ–Ω–∏–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ Prometheus –∏ –¥–∞—à–±–æ—Ä–¥–∞–º–∏ Grafana.

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø |
|---------|----------|-----|
| `kpi_tasks_total` | –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—É—á–µ–Ω–∏–π | Gauge |
| `kpi_tasks_done` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π | Gauge |
| `kpi_tasks_overdue` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π | Gauge |

### –§–æ—Ä–º—É–ª—ã KPI

- **–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: `kpi_tasks_done / kpi_tasks_total * 100`
- **–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–∫**: `kpi_tasks_overdue / kpi_tasks_total * 100`
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: `(kpi_tasks_done - kpi_tasks_overdue) / kpi_tasks_total * 100`

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤—É—é –∫–æ—Ä—É—Ç–∏–Ω—É:

```python
# app/services/scheduler.py
async def kpi_loop():
    while True:
        # –ó–∞–ø—Ä–æ—Å –∫ –ë–î
        total = await s.scalar(select(func.count()).select_from(Task))
        done = await s.scalar(select(func.count()).select_from(Task).where(Task.status == TaskStatus.COMPLETED))
        overdue = await s.scalar(select(func.count()).select_from(Task).where(Task.status == TaskStatus.PENDING, Task.deadline < date.today()))

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        TASKS_TOTAL.set(total or 0)
        TASKS_COMPLETED.set(done or 0)
        TASKS_OVERDUE.set(overdue or 0)

        await asyncio.sleep(60)
```

### –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –±–æ—Ç–æ–º:

```python
# app/bot.py
async def main():
    # ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...

    # –ó–∞–ø—É—Å–∫ KPI –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    asyncio.create_task(kpi_loop())

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    await dp.start_polling(bot)
```

## üìà Grafana –î–∞—à–±–æ—Ä–¥

### –ü–∞–Ω–µ–ª–∏

1. **–í—Å–µ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏–π** - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π
2. **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π
3. **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—É—á–µ–Ω–∏–π —Å –∏—Å—Ç–µ–∫—à–∏–º –¥–µ–¥–ª–∞–π–Ω–æ–º

### –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è

- **–ó–µ–ª–µ–Ω—ã–π** - –ø—Ä–æ—Å—Ä–æ—á–µ–∫ –Ω–µ—Ç (overdue = 0)
- **–ö—Ä–∞—Å–Ω—ã–π** - –µ—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (overdue > 0)

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

- **–§–∞–π–ª**: `grafana/provisioning/dashboards/kpi_tasks.json`
- **URL**: http://localhost:3000 (Grafana)
- **–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞**: –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Grafana

## üö® –ê–ª–µ—Ä—Ç—ã

### –ü—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∞

```yaml
# prometheus/rules.yml
- alert: TooManyOverdueTasks
  expr: kpi_tasks_overdue > 3
  for: 10m
  labels:
    severity: critical
  annotations:
    summary: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π > 3"
    description: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫—É ‚è± –ü–æ—Ä—É—á–µ–Ω–∏—è –≤ –±–æ—Ç–µ"
```

### –£—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

- **–ü–æ—Ä–æ–≥**: > 3 –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏–π
- **–í—Ä–µ–º—è**: 10 –º–∏–Ω—É—Ç (–∏–∑–±–µ–≥–∞–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**: Telegram —á–µ—Ä–µ–∑ Alertmanager

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥–∞ /kpi_test

```bash
# –í Telegram (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞)
/kpi_test
```

–í—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫:

```
üìä –¢–µ–∫—É—â–∏–µ KPI –º–µ—Ç—Ä–∏–∫–∏

üìã –í—Å–µ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏–π: 5
‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: 3
‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: 1

üí° –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏—è**:
   ```sql
   INSERT INTO tasks (title, deadline, status)
   VALUES ('–¢–µ—Å—Ç', '2024-01-01', 'PENDING');
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫–∏**:
   ```bash
   curl http://localhost:8080/metrics | grep kpi_tasks
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç–∞**:
   - –°–æ–∑–¥–∞–π—Ç–µ 4+ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏—è
   - –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 –º–∏–Ω—É—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

## üìä Prometheus Queries

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```promql
# –í—Å–µ–≥–æ –ø–æ—Ä—É—á–µ–Ω–∏–π
kpi_tasks_total

# –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Ä—É—á–µ–Ω–∏–π
kpi_tasks_done

# –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –ø–æ—Ä—É—á–µ–Ω–∏–π
kpi_tasks_overdue

# –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
kpi_tasks_done / kpi_tasks_total * 100

# –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–∫
kpi_tasks_overdue / kpi_tasks_total * 100
```

### –ì—Ä–∞—Ñ–∏–∫–∏

```promql
# –¢—Ä–µ–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞ —á–∞—Å
rate(kpi_tasks_done[1h])

# –¢—Ä–µ–Ω–¥ –ø—Ä–æ—Å—Ä–æ—á–µ–∫ –∑–∞ –¥–µ–Ω—å
rate(kpi_tasks_overdue[24h])
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ (—Å–µ–∫—É–Ω–¥—ã)
KPI_UPDATE_INTERVAL=60

# –ü–æ—Ä–æ–≥ –¥–ª—è –∞–ª–µ—Ä—Ç–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–∫
KPI_OVERDUE_THRESHOLD=3
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

```python
# app/services/scheduler.py
UPDATE_INTERVAL = int(os.getenv("KPI_UPDATE_INTERVAL", 60))
OVERDUE_THRESHOLD = int(os.getenv("KPI_OVERDUE_THRESHOLD", 3))
```

## üìã –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UI

### –ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞

```python
# app/keyboards/main_menu.py
if role == "director":
    kb = [
        [InlineKeyboardButton(text="üìä KPI", callback_data=f"{nonce}:stub")],
        [InlineKeyboardButton(text="‚è± –ü–æ—Ä—É—á–µ–Ω–∏—è", callback_data=f"{nonce}:director_tasks")]
    ]
```

### Inline –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏–π

```python
# app/handlers/director.py
@router.callback_query(lambda c: c.data.startswith("task_"))
async def toggle_task(call: CallbackQuery):
    task_id = int(call.data.split("_")[1])
    await task_repo.set_status(task_id, Status.done)
    await call.answer("‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ!")
    # –ú–µ—Ç—Ä–∏–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è KPI —Å–∏—Å—Ç–µ–º—ã:

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä** –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- ‚úÖ **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è** –≤ Grafana –¥–∞—à–±–æ—Ä–¥–µ
- ‚úÖ **–ê–ª–µ—Ä—Ç—ã** –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–∫
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å UI –±–æ—Ç–∞
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /kpi_test
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —á–µ—Ä–µ–∑ Prometheus queries

**KPI –ø–æ—Ä—É—á–µ–Ω–∏–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω!** üìä
