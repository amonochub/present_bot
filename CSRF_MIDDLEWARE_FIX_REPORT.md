# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å CSRF Middleware

## üêõ –ü—Ä–æ–±–ª–µ–º–∞
–ö–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –¥–∞–Ω–Ω—ã—Ö –≤ CSRF middleware.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–∏—á–∏–Ω–∞:
**CSRF Middleware –∏–∑–º–µ–Ω—è–µ—Ç callback –¥–∞–Ω–Ω—ã–µ**

1. **CSRF Middleware –ª–æ–≥–∏–∫–∞:**
   ```python
   # app/middlewares/csrf.py
   nonce, real_data = event.data.split(":", 1)
   event.data = real_data  # –ø–æ–¥–º–µ–Ω—è–µ–º –¥–ª—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤
   ```

2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ demo_switch():**
   - –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–ª–∞ –ø–æ–ª–Ω—ã–µ callback –¥–∞–Ω–Ω—ã–µ —Å nonce
   - –ù–æ CSRF middleware —É–∂–µ –æ—á–∏—Å—Ç–∏–ª nonce
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:
```python
# –ë—ã–ª–æ:
role_target = call.data.split("_", 1)[1]  # teacher / admin / super ...

# –ü—Ä–æ–±–ª–µ–º–∞: call.data —É–∂–µ –æ—á–∏—â–µ–Ω CSRF middleware
# –ù–∞–ø—Ä–∏–º–µ—Ä: –±—ã–ª–æ "abc123:switch_super", —Å—Ç–∞–ª–æ "switch_super"
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `app/bot.py`:

```python
# CSRF middleware —É–∂–µ –æ—á–∏—Å—Ç–∏–ª nonce, –ø–æ—ç—Ç–æ–º—É call.data —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
role_target = call.data.split("_", 1)[1]  # teacher / admin / super ...
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É** —Å callback –¥–∞–Ω–Ω—ã–º–∏ `nonce:switch_super`
2. **CSRF Middleware** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç nonce –∏ –æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–æ `switch_super`
3. **demo_switch()** –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Ö –ø–∞—Ä—Å–∏—Ç
4. **–†–æ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
5. **–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** —Å –Ω–æ–≤—ã–º nonce

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Callback Data Flow:
1. **–ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:** `nonce:switch_super`
2. **CSRF Middleware:** `nonce:switch_super` ‚Üí `switch_super`
3. **demo_switch():** `switch_super` ‚Üí `super`

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ CSRF –∑–∞—â–∏—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ nonce –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ callback
- ‚úÖ –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –í–æ–π–¥–∏—Ç–µ –≤ –¥–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç: `demo01` / `demo`
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ –ª—é–±—É—é —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Å–∏—Ö–æ–ª–æ–≥–∞)
3. –ù–∞–∂–º–∏—Ç–µ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é"
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –≤—ã–±–æ—Ä—É —Ä–æ–ª–µ–π
5. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ –¥—Ä—É–≥—É—é —Ä–æ–ª—å
6. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–æ–ª—è–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ CSRF
- ‚úÖ –ü–æ–ª–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

## üìù –°—Ç–∞—Ç—É—Å
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ä–∞–±–æ—Ç–µ CSRF middleware
- ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ**: –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
- ‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**: –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç
–¢–µ–ø–µ—Ä—å callback –¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å —É—á–µ—Ç–æ–º —Ä–∞–±–æ—Ç—ã CSRF middleware. –ö–Ω–æ–ø–∫–∞ "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ–º–æ-–º–µ–Ω—é" –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
