"""
–•—ç–Ω–¥–ª–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /help
"""
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from typing import Optional
import logging
from app.keyboards.main_menu import menu
from app.db.user import User
from sqlalchemy import select
from app.db.session import AsyncSessionLocal
from app.i18n import t

router = Router()
logger = logging.getLogger(__name__)

# helper: get current user role
async def get_user_role(tg_id: int) -> Optional[str]:
    async with AsyncSessionLocal() as s:
        user = await s.scalar(select(User).where(User.tg_id == tg_id))
        return user.role if user else None

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–æ–º–∞–Ω–¥–∞ /help ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@router.message(Command("help"))
async def help_command(msg: Message, lang: str):
    try:
        user_role = await get_user_role(msg.from_user.id)
        if not user_role:
            await msg.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.")
            return
            
        help_text = get_help_text(user_role, lang)
        await msg.answer(help_text, reply_markup=menu(user_role, lang))
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–ø—Ä–∞–≤–∫–∏: {e}")
        await msg.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–∫–∏")

def get_help_text(role: str, lang: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    if role == "teacher":
        return (
            "üë©‚Äçüè´ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —É—á–∏—Ç–µ–ª—è</b>\n\n"
            "üìù <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>–ó–∞–º–µ—Ç–∫–∏</b> ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–º–µ—Ç–æ–∫ –æ —É—á–µ–Ω–∏–∫–∞—Ö\n"
            "‚Ä¢ <b>IT-–∑–∞—è–≤–∫–∏</b> ‚Äî –ø–æ–¥–∞—á–∞ –∑–∞—è–≤–æ–∫ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
            "‚Ä¢ <b>–ú–µ–¥–∏–∞-–∑–∞—è–≤–∫–∏</b> ‚Äî –∑–∞—è–≤–∫–∏ –≤ –º–µ–¥–∏–∞—Ü–µ–Ω—Ç—Ä\n\n"
            "üí° <b>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É:</b>\n"
            "1. –ù–∞–∂–º–∏—Ç–µ ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É¬ª\n"
            "2. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: <code>–ò–º—è —É—á–µ–Ω–∏–∫–∞ –¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏</code>\n\n"
            "üí° <b>–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É:</b>\n"
            "1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞—è–≤–∫–∏ (IT –∏–ª–∏ –º–µ–¥–∏–∞)\n"
            "2. –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã\n"
            "3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª"
        )
    
    elif role == "student":
        return (
            "üë®‚Äçüéì <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</b>\n\n"
            "üìö <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>–ó–∞–¥–∞–Ω–∏—è</b> ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∏ –ø–æ—Ä—É—á–µ–Ω–∏–π\n"
            "‚Ä¢ <b>–ü–æ–º–æ—â—å –ø—Å–∏—Ö–æ–ª–æ–≥–∞</b> ‚Äî –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —à–∫–æ–ª—å–Ω–æ–º—É –ø—Å–∏—Ö–æ–ª–æ–≥—É\n\n"
            "üí° <b>–ö–∞–∫ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Å–∏—Ö–æ–ª–æ–≥—É:</b>\n"
            "1. –ù–∞–∂–º–∏—Ç–µ ¬´üÜò –ü—Å–∏—Ö–æ–ª–æ–≥¬ª\n"
            "2. –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É\n"
            "3. –ü—Å–∏—Ö–æ–ª–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è"
        )
    
    elif role == "parent":
        return (
            "üë™ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è</b>\n\n"
            "üìö <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>–ó–∞–¥–∞–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞</b> ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞–Ω–∏–π –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞\n"
            "‚Ä¢ <b>–°–ø—Ä–∞–≤–∫–∏</b> ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ–∫\n\n"
            "üí° <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø—Ä–∞–≤–∫–∏:</b>\n"
            "‚Ä¢ –°–ø—Ä–∞–≤–∫–∞ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏\n"
            "‚Ä¢ –°–ø—Ä–∞–≤–∫–∞ –æ–± —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏\n"
            "‚Ä¢ –°–ø—Ä–∞–≤–∫–∞ –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏"
        )
    
    elif role == "psych":
        return (
            "üßë‚Äç‚öïÔ∏è <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∞</b>\n\n"
            "üì• <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>–í—Ö–æ–¥—è—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</b> ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤\n"
            "‚Ä¢ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π\n\n"
            "üí° <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏:</b>\n"
            "1. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π\n"
            "2. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫–∞–∂–¥–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ\n"
            "3. –û—Ç–º–µ—Ç—å—Ç–µ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ"
        )
    
    elif role == "admin":
        return (
            "üèõ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n"
            "üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>–ó–∞—è–≤–∫–∏ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏</b> ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ IT-–∑–∞—è–≤–∫–∞–º–∏\n"
            "‚Ä¢ <b>–ú–µ–¥–∏–∞-–∑–∞—è–≤–∫–∏</b> ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –º–µ–¥–∏–∞—Ü–µ–Ω—Ç—Ä–∞\n"
            "‚Ä¢ <b>–†–∞—Å—Å—ã–ª–∫–∞</b> ‚Äî –º–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π\n\n"
            "üí° <b>–ö–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞—è–≤–∫–∞–º–∏:</b>\n"
            "1. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫\n"
            "2. –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ ¬´–í —Ä–∞–±–æ—Ç–µ¬ª –∏–ª–∏ ¬´–í—ã–ø–æ–ª–Ω–µ–Ω–æ¬ª\n"
            "3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
        )
    
    elif role == "director":
        return (
            "üìä <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</b>\n\n"
            "üìà <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
            "‚Ä¢ <b>KPI –æ—Ç—á–µ—Ç</b> ‚Äî —Å–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —à–∫–æ–ª—ã\n"
            "‚Ä¢ <b>–ó–∞–¥–∞—á–∏</b> ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏—è–º–∏\n\n"
            "üí° <b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ <code>/kpi</code> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å KPI –æ—Ç—á–µ—Ç\n"
            "‚Ä¢ <code>/help</code> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "üìä <b>KPI –≤–∫–ª—é—á–∞–µ—Ç:</b>\n"
            "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫ —É—á–∏—Ç–µ–ª–µ–π\n"
            "‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫ –∏ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è\n"
            "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö"
        )
    
    else:
        return (
            "‚ùì <b>–û–±—â–∞—è —Å–ø—Ä–∞–≤–∫–∞</b>\n\n"
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —à–∫–æ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É!\n\n"
            "üí° <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ <code>/start</code> ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
            "‚Ä¢ <code>/help</code> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
            "‚Ä¢ <code>/theme</code> ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º—É\n\n"
            "üîß <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>\n"
            "–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã."
        )

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@router.callback_query(F.data == "help")
async def help_button(call: CallbackQuery, lang: str):
    try:
        user_role = await get_user_role(call.from_user.id)
        if not user_role:
            await call.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.", show_alert=True)
            return
            
        help_text = get_help_text(user_role, lang)
        await call.message.edit_text(help_text, reply_markup=menu(user_role, lang))
        await call.answer()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–ø—Ä–∞–≤–∫–∏: {e}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–∫–∏", show_alert=True) 